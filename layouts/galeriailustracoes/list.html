<link rel="stylesheet" type="text/css" href="/assets/css/geral.css"> <!-- Chamando CSS geral -->
<link rel="stylesheet" type="text/css" href="/assets/css/galeriailustracoes.css">

{{- partial "htmlhead" . -}}<!-- puxando as metatags -->
{{- partial "navigationlinks" . -}}<!-- puxando os menus -->

<body lang='{{ .Site.LanguageCode | default "pt-br" }}' class="is-preload">
    <div id="main">
        {{- partial "pageHeaderMenuAndLogo" . -}}
        <div id="container-ilustracoesHeader">
            <div class="container-header-name" id="galeria-ilustracoes-header-name">
                <h1>Galeria Visual</h1>
            </div>
        </div>

        <span id="array" idsArray="{{ .Params.ProjetosIds }}"></span>

        <div id="organizer-galeria-ilustracoes">
            {{ range .Pages.ByWeight  }}
                <div id="{{ .Params.Projectid }}"
                    onclick="abrirproj(event, '{{ .Params.Projectid }}')"
                    itens="{{ jsonify .Params.Itens }}"
                    lojalink="{{ .Params.Lojalink }}"
                    class="{{ .Params.Class }}"
                    backgroundcolor="{{ .Params.Backgroundcolor | safeCSS }}"
                    >
                    <img src="{{ .Params.Thumbprojeto }}" class="animation-element not-shown-img-state" alt="{{ .Params.altthumb }}"> 
                </div>           
            {{ end }}
        </div>
        {{- partial "listademateriais" . -}}
        {{- partial "emailing.html" . -}}
        {{- partial "rodape.html" . -}}
    </div>
    {{- template "_internal/google_analytics.html" . }}
    {{- partial "scripts/index" . }}
    {{- partial "meusscripts" . }}
</body>

<script>
    let openLink = function(link){ //Abrir links do projeto (botões e hiperlinks chamam essa função)
        window.open(link);
    }

    window.addEventListener('load', ()=> { //Checa se já entrou na página com algum ID aberto
        const id = new URLSearchParams(window.location.search).get('id'); 
        if(id) {
            abrirproj('', id);
        }
    });

    let updateURLNoDisturbing = function(id){ // Setando a URL para que aas pessoas possam compartilhar
        const newURL = '?id=' + id; 
        history.replaceState({}, "New Page", newURL);
    }

    /* let lastResize = 0;
    let changePositionOfCloseButton = function() { 
        if(Date.now() - lastResize > 500) {
            lastResize = Date.now();

            rect = document.getElementById('openProject').getBoundingClientRect();
            
            buttonClose = document.getElementById('topButtonsContainer');
            console.log(rect.x, rect.width, buttonClose.clientWidth);
            buttonClose.style.paddingLeft = `${rect.x + rect.width - buttonClose.scrollWidth}px`;
        }
    } */

    let createSnackbar = function(id) {   
        //CRIANDO SNACKBAR DA ONDE VAI ENTRAR OS TRABALHOS
        let snackbar = document.createElement('div');
        snackbar.classList = 'snackbar';
        snackbar.id = 'snackbarId';
        document.body.style.cssText = 'overflow: hidden';
        snackbar.style.backgroundColor = document.getElementById(id).getAttribute('backgroundcolor');
    
        //CRIANDO TOP PART
        let topButtonsContainer = "";
        let lojalink = document.getElementById(id).getAttribute('lojalink');
        
        if (lojalink != ""){
            topButtonsContainer = 
            `<div id='container-top-buttons-snackbarproj'>
                <div class='buttonLojaProject' onclick="openLink(' `+ lojalink +` ')">
                    <span class='fa-solid fa-cart-shopping fa-lg'></span> 
                </div>
                <div class='buttonCloseProject' onclick="closeSnackbarProj()">
                    <span class='fa-solid fa-x fa-lg'></span>
                </div>
            </div>`
        } else {
            topButtonsContainer = 
            `<div class='container-top-buttons-snackbarproj'>
                <div class='buttonCloseProject' onclick="closeSnackbarProj()>
                    <span class='fa-solid fa-x fa-lg' aria-hidden='true'"></span>
                </div>
            </div>`
        }

        //CRIANDO MIOLO
        // Criando o botão prev 
        let openProject = `<div id='container-openProject-and-arrows'>` 
            + `<div id="container-prev-button-gallery-ilustracoes">
                <div id="prev-button-gallery-ilustracoes" onclick="changeSlideProj(-1)">
                    <span class='fa fa-chevron-left fa-lg' aria-hidden='true'></span>
                </div>
            </div><div id="openProject">`

        // Inserindo o conteúdo    
        let itens = JSON.parse(document.getElementById(id).getAttribute('itens'));
        for (let item of itens){
            if (item.type == 'image'){
                openProject += '<img src="' + item.src + '" width="' + item.width + 'px" height="' + item.height + 'px" alt="'+ item.alt +'"  style="display:block; object-fit: contain; max-height: 89vh; margin:'+item.margin+'" class="snackZoom '+ item.class +'" id="snackZoomId"/>'
            }
            if (item.type == 'imageSide'){
                openProject += '<div class="imagesSideBySide" margin:"'+item.margin+' column-gap:' + item.columngap +'">'
                for(i=0; i < item.src.length; i++){
                    openProject += '<img src="' + item.src[i] + '" alt="'+ item.alt[i] +'"  style="display:block; object-fit: contain; max-height: 89vh;margin-top:'+ item.imgmargintop[i] +'" class="snackZoom ' + item.class + '" id="snackZoomId"/>';
                }
                openProject += '</div>'
            }
            if (item.type == 'video') {
                openProject += '<div style="margin:'+ item.margin +';" class="iframecontainer" id="snackZoomId"><iframe src="' + item.src + '" alt="' + item.alt + '" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" frameorder="0" vspace="0" hspace="0" marginwidth="0" marginheight="0" width="100%" style="margin: 0 0 0 0" frameBorder="0" scrolling="no" style="border: 0px" allowfullscreen></iframe></div>'
            }
            if(item.type == 'text'){
                openProject += '<p style="color:'+ item.textcolor + '!important; margin:'+ item.margin +';text-align:'+ item.textalign +'">'+ item.text +'</p>'
            }
        }

        // Criando o botão next 
        openProject += ` </div>
            <div id="container-next-button-gallery-ilustracoes">
                <div id="next-button-gallery-ilustracoes" onclick="changeSlideProj(1)">
                    <span class='fa fa-chevron-right fa-lg' aria-hidden='true'></span>
                </div>
            </div> 
        </div>`;
        
        snackbar.innerHTML = topButtonsContainer + `<div id="container-openProject"> `+  openProject  + `</div> `; // Snackbar totalmente construida
        document.body.append(snackbar); // Adiciona a snack ao body

        realignVertical("openProject");
        setupSliderGaleria();// Slide da galeria no mobile
        updateURLNoDisturbing(id);
    }

    /* Slide no mobile */
    let setupSliderGaleria = function() {
        let touchsurface = document.getElementById('snackbarId'),
        startX, 
        startY,
        dist,
        distThreshold,
        thresholdX = 50,
        thresholdY = 50,
        allowedTime = 1500,
        elapsedTime,
        startTime

        touchsurface.addEventListener ('touchstart', function(e) {
            let touchobj = e.changedTouches[0];
            
            dist = 0;
            distThreshold = 0;
            startX = touchobj.pageX;
            startY = touchobj.pageY;
            startTime = new Date().getTime();
        }, false)

        touchsurface.addEventListener('touchend', function(e) {
            var touchobj = e.changedTouches[0];
            dist = touchobj.pageX - startX;
            distThreshold = Math.abs(dist);
            elapsedTime = new Date().getTime() - startTime;
           
            if (
                elapsedTime <= allowedTime &&
                distThreshold >= thresholdX &&
                Math.abs(touchobj.pageY - startY) <= thresholdY &&
                dist > 0
            ){
                changeSlideProj(-1);
            }

            if (
                elapsedTime <= allowedTime &&
                distThreshold >= thresholdX &&
                Math.abs(touchobj.pageY - startY) <= thresholdY &&
                dist < 0)
            {                                         
                changeSlideProj(1);
            }
        }, false)
    }

    let idsArray = document.getElementById("array").getAttribute("idsArray"); //Criando array com os projetos existentes para permitir funcionamento dos slides
    let splitIdsArray = idsArray.replace("]","").replace("[","").split(' ')
    let totalProjectNum = splitIdsArray.length

    let changeSlideProj = function(botao){  //Funcionamento dos slides
        closeSnackbarProj(); //Fecha o projeto aberto para criar a nova snackbar
        if(botao == 1) {
            if(currentFocusProject + 1 >= totalProjectNum) {
                currentFocusProject = 0;
            } else {
                currentFocusProject += 1;
            }
        } else {
            if(currentFocusProject == 0) {
                currentFocusProject = totalProjectNum - 1;
            } else {
                currentFocusProject -= 1;
            }
        }
        abrirproj('', splitIdsArray[currentFocusProject]); //Cria a nova snack com a nova id
    }
    
    let currentFocusProject;
    let id;
    let abrirproj = function (e, id){
        if (e) e.stopPropagation();
        document.getElementById(id);

        flagProjAberto = true;
        createSnackbar(id);
        
        currentFocusProject = splitIdsArray.indexOf(id);
    }
  
    function closeSnackbarProj(){/*Função para fechar snack e retornar elementos ao padrão*/
        let snackbarToClose = document.getElementById('snackbarId')
        snackbarToClose.remove()

        document.body.style.cssText = 'overflow: auto';
        document.body.className = 'normal';
        flagProjAberto = false;
    }
</script>